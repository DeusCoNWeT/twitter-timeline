<!--
@license
Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/core-ajax/core-ajax.html">
<link rel="import" href="bower_components/core-icon/core-icon.html">
<link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>

<polymer-element name="twitter-timeline" attributes="accessToken secretToken consumerKey consumerSecret count">
    <template>
        <!-- Importacion del CSS a usar -->
        <link rel="stylesheet" href="twitter-timeline.css">
        <!-- Request a la api de twitter solicitando el timeline. Para ello son necesarios todos los tokens -->
        <core-ajax 
                   id="requestTimeline"
                   url="http://twitter-timeline-app.appspot.com/oauth/twitter"
                   method="GET"
                   params='{
                           "access_token": "{{accessToken}}",
                           "secret_token": "{{secretToken}}",
                           "consumer_key": "{{consumerKey}}",
                           "consumer_secret": "{{consumerSecret}}",
                           "count": "{{count}}"
                           }'
                   handleAs='json'
                   on-core-response="{{response}}"
                   >
        </core-ajax>

        <paper-shadow>
            <!-- Cabecera -->
            <div id ="cabecera">
                <p style="text-align:center">Tu Timeline</p>
            </div>
            <!-- Timeline box -->
            <div style="overflow-y: auto;max-height: 400px">
                <template id="contenido" is="auto-binding" repeat="{{events}}">
                    <ul class="box">
                        <!-- Imagen de la persona que publica -->
                        <core-icon  src="{{user.profile_image_url}}" class="imgEvent">
                        </core-icon>
                        <!-- Cabecera de la publicacion -->
                        <div style="text-align: left">
                            <a class="nounderline" href="https://twitter.com/{{user.screen_name}}" target='_blank'>
                                <span class="fullname">{{user.name}}</span>
                                <span class="username">@{{user.screen_name}}</span>
                            </a>
                            <template if=!{{retweeted_status}}>
                                <a class="nounderline time" href="https://twitter.com/{id}}/status/{{id_str}}" target='_blank'>
                                    <span>{{tiempo}}</span>
                                </a>
                            </template>
                            <template else={{retweeted_status}}>
                                <a class="nounderline time"
                                   href="https://twitter.com/{{retweeted_status.id}}/status/{{retweeted_status.id_str}}" target='_blank'>
                                    <p>{{tiempo}}</p>
                                </a>
                            </template>
                        </div>
                        <p class="text">{{text}}</p>
                    </ul>
                </template>
                <template if="{{ show}}">
                    <ul class="box" style="text-align:center;cursor: pointer;font-size: 16px"  on-click={{mostrar}}>
                        <span style="font-size: 12px">Mostrar m√°s</span>
                    </ul>
                </template>
            </div>
        </paper-shadow>
    </template>



    <script>
        Polymer({
            index: 0,
            show: true,
            ready: function(event, detail, sender) {
                this.$.requestTimeline.go();
            },
            response: function(event, detail, sender) {
                this.events = this.changeTime(sender.response);
                this.mostrar()
            },
            mostrar: function(){
                var tweets = new Array();
                if (this.events.length - this.index > 20){
                    for(i = 0; i<this.index+20;i++){
                        tweets[i] = this.events[i];
                    }
                    this.index += 20;
                    if (this.events.length - this.index < 20)
                        this.show = false;
                    var t = this.$.contenido;
                    t.events = tweets;
                }
            },
            changeTime: function(list){
                for (i=0;i<list.length;i++){
                    var date = new Date(list[i].created_at);
                    var current_date = new Date();
                    if((current_date.getDay() - date.getDay()) == 0 ){
                        if((current_date.getHours() - date.getHours()) == 0 ){
                            if( (current_date.getMinutes() - date.getMinutes()) == 0 ){
                                list[i].tiempo = current_date.getSeconds() - date.getSeconds()+" segundos"
                            }
                            else{
                                list[i].tiempo = current_date.getMinutes() - date.getMinutes()+" minutos";
                            }
                        }
                        else{
                            if (current_date.getHours() - date.getHours() == 1)
                                list[i].tiempo = current_date.getHours() - date.getHours()+" hora";
                            else
                                list[i].tiempo = current_date.getHours() - date.getHours()+" horas";
                        }
                    }
                    else if( (current_date.getDay() - date.getDay()) < 15 ){
                        list[i].tiempo = current_date.getDay() - date.getDay()+" dias";
                    }
                    else{
                        var month = ['Enero','Febrero','Marzo','Abril', 'Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
                        list[i].tiempo = date.getDate()+" de "+month[date.getMonth()]+" de "+date.getFullYear();
                    }
                }
                return list;
            },
        })
    </script>
</polymer-element>
