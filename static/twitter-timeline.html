<!--
@license
Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="bower_components/iron-icon/iron-icon.html">
<link rel="import" href="bower_components/iron-icons/iron-icons.html">
<link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="bower_components/paper-material/paper-material.html">
<link rel="import" href="bower_components/iron-flex-layout/classes/iron-flex-layout.html">



<dom-module id="twitter-timeline">
  <style is="custom-style">
    @font-face {
      font-family: HelveticaNeue;
      src: url('font/HelveticaNeueLTStd-Ex.otf');
    }
    :host{
      display: inline-block;
    }

    .box {
      border: 1px solid #d0f0f0;
      border-bottom: 1px solid #d0f0f0;
      border-left: 1px solid #d0f0f0;
      max-width: 400px;
      min-width: 350px;
      padding:10px 5px;
      margin:0;
      font-size: 14px;
      background: #fff; /* Old browsers */



    }

    #header {
      background: #55acee; /* Old browsers */
      color:#fff;
      border-top-left-radius: 5px;
      border-top-right-radius: 5px;
      font-family: 'Helvetica',sans-serif;
      font-weight: 800;
      font-size: 16px;
      padding: 3px 8px;
    }

    #header > p {
      text-align:center;
      padding-left:50px;
    }
    #contain {
      overflow-y: auto;
      max-height: 400px;
    }
    #end {
      background: #55acee;
      border-bottom-left-radius: 5px;
      border-bottom-right-radius: 5px;
      height: 2px;
    }

    .imgEvent {
      float: left;
      width:50px;
      height:50px;
      margin: 2px 15px;
    }

    .imgEvent > div {
      border-radius: 20%;
    }

    .fullname {
      font-weight: bold;
      color: #292f33;
    }

    .fullname:hover{
      color: #1E9999;
      text-decoration:underline;
    }

    .username {
      font-size: 13px;
      color: #8899a6;
    }

    .nounderline {
      text-decoration:none;
      margin-right: 5px;
    }

    .time {
      font-size: 13px;
      color: #8899a6;
    }

    .time:hover{
      color: #1E9999;
      text-decoration: underline;
    }

    .text {
      font-size: 13px;
      font-family: HelveticaNeue,Helvetica,Arial,sans-serif;
      margin:5px 0px;
    }

    .button{
      background: #fff;
      cursor: pointer;
      text-align: center;
      font-size: 14px;
      font-family:'Helvetica','sans-serif';
      color: #55acee;
      font-style: oblique;
      transition: background .2s linear, border-radius 1s ease-in 1s;
    }
    .button:hover {
      background: #55acee;
      color: #fff;
    }
    ::-webkit-scrollbar {
      width: 4px;
      background: #b9b9b9;
    }

    ::-webkit-scrollbar-thumb {
      background: #55acee;
      -webkit-border-radius: 1ex;
    }
    .refresh {
      text-align: right;
    }

    .refresh_button {
      height: 28px;
      width: 28px;
      padding:0;
      margin:auto;
    }
  </style>
  <template>
    <!-- Request to the API. Tokens are necessary -->
    <iron-ajax 
               id="requestTimeline"
               url="{{ endpoint }}"
               method="GET"
               params="{{timeline_params}}"
               handleAs='json'
               on-response="_response"
               >
    </iron-ajax>

    <iron-ajax
               id="requestLanguage"
               url="{{language_url}}"
               method="GET"
               handleAs="json"
               on-response="_language_response"
               >
    </iron-ajax>

    <paper-material>
      <!-- Header -->
      <paper-material>
        <div id ="header" class="horizontal center-justified layout">
          <p class="flex">{{data.title}}</p>
          <paper-icon-button class="refresh_button" title="{{data.refresh}}" icon="refresh" on-click="refresh_func">
          </paper-icon-button>
        </div>
      </paper-material>
      <!-- Timeline box -->
      <div id="contain">
        <template id="tweets" is="dom-repeat" items="{{events}}" filter="_filter">
          <ul class="box horizontal layout ">
            <!-- Profile picture -->
            <iron-icon src="{{item.user.profile_image_url_https}}" class="imgEvent">
            </iron-icon>
            <!-- Publication Header -->
            <div style="text-align: left" class="vertical layout flex">
              <div class="horizontal layout ">
                <a class="nounderline" href="{{_getUserurl(item.user.screen_name)}}" target='_blank'>
                  <span class="fullname">{{item.user.name}}</span>
                  <span class="username">@<span>{{item.user.screen_name}}</span></span>
                </a>
                <!-- No funcionara, hay que meter un if computado -->

                <template is="dom-if" if="{{_withoutStatus(item.retweeted_status)}}">
                  <a class="nounderline time" href="{{_getStatusUrl(item.id, item.id_str)}}" target="_blank">
                    <span>{{item.time}}</span>
                  </a>
                </template>
                <template is="dom-if" if="{{item.retweeted_status}}">
                  <a class="nounderline time"
                     href="{{_getStatusUrl(item.retweeted_status.id, item.retweeted_status.id_str)}}" target="_blank">
                    <span>{{item.time}}</span>
                  </a>
                </template>
              </div>
              <p class="text" id="{{_getTextId(index)}}" inner-h-t-m-l="{{item.text}}"></p>
            </div>
          </ul>
        </template>
        <template if="{{show}}" is="dom-if">
          <ul class="box button" on-click="toDisplay">
            <span>{{data.load_more}}</span>
          </ul>
        </template>
      </div>
      <div id="end"></div>
    </paper-material>
  </template>

  <script>
    Polymer({
      is:"twitter-timeline",
      properties: {
        index: {
          type: Number,
          value: 5
        },
        show: {
          type: Boolean,
          value: true,
        },

        since_id: {
          type: String,
          value:""
        },

        endpoint: {
          type: String,
          notify: true,
          reflectToAttribute: true
        },
        language: {
          type: String,
          value: "es",
          reflectToAttribute: true,
          observer: "languageChanged"
        },
        count: { 
          type: Number,
          value: 200,
          notify: true,
          reflectToAttribute: true
        },

        /*1 seg = 1000*/
        refresh_time: {
          type: Number,
          value: 60000,
          notify: true,
          reflectToAttribute: true
        },
        accessToken: {
          type: String,
          value: "",
          notify: true,
          reflectToAttribute: true
        },
        secretToken: {
          type: String,
          value: "",
          notify: true,
          reflectToAttribute: true 
        },
        consumerKey: {
          type: String,
          value: "",
          notify: true,
          reflectToAttribute: true 
        },
        consumerSecret: {
          type: String,
          value: "",
          notify: true,
          reflectToAttribute: true 
        },
        language_url: {
          type: String,
          computed: "_calculateLanguageUrl(idiom)"
        },
        timeline_params: {
          type: String,
          computed: "_calculateTimelineParams(accessToken, secretToken, consumerKey, consumerSecret, count)"
        },
        events: {
          type: Array,
          value: [],
          notify: true
        }
      },

      /* Language observer */
      languageChanged: function(newVal, oldValue) {
        if(newVal === "en"){
          this.language = "en";
          this.idiom = "en_en.json"
          this.$.requestLanguage.generateRequest();
        }
        else if(newVal === "es"){
          this.language = "es";
          this.idiom = "es_es.json"
          this.$.requestLanguage.generateRequest();
        }
      },
      observers: ["renderTemplate(index, events.*)"],
      renderTemplate: function(index, events) {
        this.$.tweets.render();
      },
      /* This function prepares the tweets before displaying them */
      _response: function(event, detail) {
        var parsed = this.parser(this._changeTime(detail.response));
        this.set('events',parsed);
        /*        for (i=0;i<parsed.length;i++){
          this.push('events', parsed[i]);
        }*/
      },
      _language_response: function(event, detail){
        this.data = detail.response;
        /* If its a new request, we set events to new value*/
        if(this.events.length === 0){
          this.$.requestTimeline.generateRequest();
          var back = this
          window.setInterval(function(){back.$.requestTimeline.generateRequest();}, back.refresh_time);
        } else{
          /* Else we had elements, we change events.*.time*/
          var newEvents = this._changeTime(this.splice('events',0,this.events.length));
          for (i=0;i<newEvents.length;i++){
            this.push('events', newEvents[i])
          }

        }
      },
      /* Function that refresh the timeline */
      refresh_func: function(){
        this.$.requestTimeline.generateRequest();
      },
      /* Function that displays the date when the tweets was published */
      _changeTime: function(list){
        for (i=0;i<list.length;i++){
          var date = new Date(list[i].created_at);
          var current_date = new Date();
          /* Años*/
          if ((current_date.getFullYear() - date.getFullYear()) != 0) {
            var dif = current_date.getFullYear() - date.getFullYear()
            list[i].time = dif==1 ? dif + " " + this.data.year : dif + " " + this.data.years;
            /* Meses */
          } else if ((current_date.getMonth() - date.getMonth()) != 0) { 
            var dif = current_date.getMonth() - date.getMonth();
            list[i].time = dif==1 ? dif + " " + this.data.month : dif + " " + this.data.months;
            /* Dias */
          } else if((current_date.getDate() - date.getDate()) == 0 ){
            if((current_date.getHours() - date.getHours()) == 0 ){
              if( (current_date.getMinutes() - date.getMinutes()) == 0 ){
                list[i].time = current_date.getSeconds() - date.getSeconds()+" "+this.data.seconds
              }
              else{
                list[i].time = current_date.getMinutes() - date.getMinutes()+" "+this.data.minutes
              }
            }
            else{
              if (current_date.getHours() - date.getHours() == 1)
                list[i].time = current_date.getHours() - date.getHours()+" "+this.data.hour;
              else
                list[i].time = current_date.getHours() - date.getHours()+" "+this.data.hours;
            }
          }
          else if( ((current_date.getDate() - date.getDate()) < 15) && ( (current_date.getDate() - date.getDate()) > 0)){
            if( (current_date.getDate() - date.getDate()) == 1){
              list[i].time = current_date.getDate() - date.getDate()+" "+this.data.day
            }
            else{
              list[i].time = current_date.getDate() - date.getDate()+" "+this.data.days
            }
          }
          else{
            var month = [this.data.january,this.data.february,this.data.march,this.data.april, this.data.may,this.data.june,this.data.july,this.data.august,this.data.september,this.data.october,this.data.november,this.data.december];
            list[i].time = date.getDate()+" "+this.data.of+" "+month[date.getMonth()]+" "+this.data.of+" "+date.getFullYear();
          }
        }
        return list;
      },
      /* Function that parse the tweet's text */
      parser: function(list){
        for(i = 0; i < list.length; i++){
          if(list[i].retweeted_status){
            list[i].text = this.parseURL(list[i].retweeted_status.text);
            list[i].text = this.parseUsername(list[i].text);
            list[i].text = this.parseHashtag(list[i].text);
          }
          else{
            list[i].text = this.parseURL(list[i].text);
            list[i].text = this.parseUsername(list[i].text);
            list[i].text = this.parseHashtag(list[i].text);
          }
        }
        return list;
      },
      /* URLs parser */
      parseURL: function(tweet) {
        return tweet.replace(/[A-Za-z]+:\/\/[A-Za-z0-9-_]+\.[A-Za-z0-9-_:%&~\?\/.=]+/g, function(url) {
          return '<a style="color:rgb(57, 145, 212)" href='+url+' target="_blank">'+url+'</a>'
        })
      },
      /* Usernames parser */
      parseUsername: function(tweet) {
        return tweet.replace(/[@]+[A-Za-z0-9-_]+/g, function(u) {
          var username = u.replace("@","")
          return '<a style="color:rgb(57, 145, 212)" href="https://twitter.com/'+username+' "target="_blank">@'+username+'</a>'
        })
      },
      /* Hashtags parser */
      parseHashtag: function(tweet) {
        return tweet.replace(/[#]+[A-Za-z0-9-_ñáéíóúàèìòùç]+/g, function(t) {
          var tag = t.replace("#","")
          return '<a style="color:rgb(57, 145, 212)" href="https://twitter.com/hashtag/'+tag+' "target="_blank">#'+tag+'</a>'
        });
      },
      /* Function that handles paging tweets*/
      toDisplay: function(){
        if (this.index >= this.events.length) {
          this.show = false;
        } else {
          this.index+=20;
          if (this.index >= this.events.length) {
            this.show = false;
          }
        }
        
      },
      /* Calculate endpoint for request url */
      _calculateLanguageUrl: function(file) {
        return "language/" + file; 
      },
      _calculateTimelineParams: function(accessToken, secretToken, consumerKey, consumerSecret, count) {
        return {
          access_token: accessToken,
          secret_token: secretToken,
          consumer_key: consumerKey,
          consumer_secret: consumerSecret,
          count: count
        };
      },
      _getUserurl: function(user) {
        return "https://twitter.com/" + user;
      },
      _getStatusUrl: function(id, id_str) {
        return "https://twitter.com/" + id + "/status/" + id_str;
      },
      _getTextId: function(index) {
        return "Text" + index; 
      },
      _withoutStatus: function(status) {
        return !status; 
      },
      _filter: function(item){
        var dentro = false;
        for (i=0;i<this.events.length && i<this.index && !dentro;i++) {
          if (this.events[i].id === item.id)
            dentro = true;
        }
        return dentro;
      }
    })
  </script>
</dom-module>
